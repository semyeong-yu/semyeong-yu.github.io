---
layout: distill
title: 3DGS Code Review
date: 2024-12-29 12:00:00
description: 3D Gaussian Splatting for Real-Time Radiance Field Rendering (SIGGRAPH 2023)
tags: 3DGS code
categories: 3d-view-synthesis
thumbnail: assets/img/2024-12-29-3DGScode/1m.PNG
giscus_comments: false
disqus_comments: true
related_posts: true
toc:
  - name: train.py
  - name: Gaussian Initialize
  - name: Densification
  - name: GS Rasterize
    subsections:
      - name: FORWARD
      - name: BACKWARD
      - name: markVisible
_styles: >
  .fake-img {
    background: #bbb;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 0px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 12px;
  }
  .fake-img p {
    font-family: monospace;
    color: white;
    text-align: left;
    margin: 12px 0;
    text-align: center;
    font-size: 16px;
  }
---

> code :  
[https://github.com/graphdeco-inria/gaussian-splatting](https://github.com/graphdeco-inria/gaussian-splatting)  
reference :  
https://charlieppark.kr  
NeRF and 3DGS Study

## Code Flow Diagram

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/17m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    reference : https://charlieppark.kr
</div>

## train.py

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/1m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    Fig 1. train.py Algorithm
</div>

```python
gaussians = GaussianModel(dataset.sh_degree)
scene = Scene(dataset, gaussians)
```

## Gaussian Initialize

Fig 1.의 빨간 박스 : SfM pcd로부터 Gaussian param. 초기화

```python
class Scene:
  def __init__(...):
    ...
    self.gaussians.create_from_pcd(scene_info.point_cloud, self.cameras_extent)  
```

- scene 폴더의 $$\text{__init__.py}$$ 에서 $$\text{class Scene.__init__()}$$ :  
  - scene_info :  
  Colmap 또는 Blender의 pcd, camera info.를 받아옴  
    - pcd : scene_info.point_cloud
    - camera : scene_info.train_cameras, scene_info.test_cameras
  - self.gaussians.create_from_pcd() :  
  SfM pcd로부터 Gaussian param.들을 initialize


<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/9m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    class Scene.__init__()
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/10m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    sceneLoadTypeCallbacks(dict) > readColmapSceneInfo
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/2m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    GaussianModel.create_from_pcd()
</div>

## Densification

Fig 1.의 초록 박스 : densification (clone and split)

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/3m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    train.py
</div>
 
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/4m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    GaussianModel.add_densification_stats()
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/5m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    GaussianModel.densify_and_prune()
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/6m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    GaussianModel.densify_and_clone(), GaussianModel.densify_and_split()
</div>

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/7m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    GaussianModel.densification_postfix()
</div>

## GS Rasterize

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/8m.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    Fig 2. GS Rasterize Algorithm
</div>

Fig 2.의 노란 박스 : GS rasterization by CUDA

- gaussian_renderer 폴더의 $$\text{__init__.py}$$ 에서 $$\text{render()}$$ :  

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/11.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    render()
</div>

- GaussianRasterizer(nn.Module) :  
C++/CUDA rasterization routine을 invoke

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/12.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    diff_gaussian_rasterization.__init__.py.GaussianRasterizer(nn.Module)
</div>

- _RasterizeGaussians(torch.autograd.Function) :  
  - goal :  
    - MLP weight가 아니라 3DGS param.를 gradient-based back-progapagation으로 update해야 함  
    - `torch.autograd.Function` 함수를 override하여  
    `@staticmethod`로 `forward()`와 `backward()` 정의  
    - `ctx.save_for_backward()`와 `ctx.saved_tensors`를 이용해서  
    forward()에서 backward()로 정보 전달
    - backward()에서 자동 미분(autograd) 말고 gradient를 manually 지정함으로써 효율적인 계산 가능  
  - torch.autograd.Function.forward()  
  _C.rasterize_gaussians() 호출해서 rasterization 결과 반환
  - torch.autograd.Function.backward()  
  _C.rasterize_gaussians_backward() 호출해서 gradient 반환

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/13.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    diff_gaussian_rasterization.__init__.py._RasterizeGaussians(torch.autograd.Function).forward()
</div>
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/14.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    diff_gaussian_rasterization.__init__.py._RasterizeGaussians(torch.autograd.Function).backward()
</div>

- setup.py 에서 setup() : C++/CUDA 확장
  - ext_modules : pytorch용 CUDA Extension 정의
    - `CUDAExtension()` : pytorch에서 CUDA Extension 패키지를 빌드하는 module
    - name : compiled CUDA Extension 패키지 이름
    - sources : 컴파일할 C++/CUDA source codes

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/15.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    C++/CUDA code를 컴파일하여 diff_gaussian_rasterization._C 패키지를 만들기 위한 setup.py
</div>

- ext.cpp 컴파일 :  
`PYBIND11_MODULE()`로 python 함수와 rasterize_points.cu 의 CUDA 함수를 연결

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/16.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="caption">
    python 함수와 rasterize_points.cu 의 CUDA 함수를 PYBIND11_MODULE()로 연결
</div>

- rasterize_points.cu :  
  - RasterizeGaussiansCUDA()  
  color, radii 저장을 위한 tensor 만들고 geometry, bin, image 저장을 위한 buffer 만든 뒤  
  CudaRasterizer::Rasterizer::forward() 호출  
  (`namespace::class::static function` 형식)
  - RasterizeGaussiansBackwardCUDA()  
  each param. gradient 저장을 위한 tensor 만든 뒤  
  CudaRasterizer::Rasterizer::backward() 호출
  - markVisible()  
  present tensor 만든 뒤  
  CudaRasterizer::Rasterizer::markVisible() 호출

- buffer 만들기 : obtain() 함수 사용

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/25.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

- rasterizer_impl.cu :  
  - int CudaRasterizer::Rasterizer::forward()  
  (아래의 ### FORWARD section에서 설명)
    - FORWARD::preprocess() 호출  
    $$\rightarrow$$ $$\text{preprocessCUDA<> <<<,>>>()}$$ 호출
    - cub::DeviceScan::InclusiveSum() 호출
    - $$\text{duplicatedWithKeys<<<,>>>()}$$ 호출
    - cub::DeviceRadixSort::SortPairs() 호출
    - $$\text{identifyTileRanges<<<,>>>()}$$ 호출
    - FORWARD::render() 호출  
    $$\rightarrow$$ $$\text{renderCUDA<> <<<,>>>()}$$ 호출

```c++
// create a tile grid (a group of blocks)
dim3 tile_grid((width + BLOCK_X - 1) / BLOCK_X, (height + BLOCK_Y - 1) / BLOCK_Y, 1);
// create a block (a group of threads(pixels))
dim3 block(BLOCK_X, BLOCK_Y, 1);
```

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/19.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/20.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/21.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

- rasterizer_impl.cu :  
  - void CudaRasterizer::Rasterizer::backward()  
  (아래의 ### BACKWARD section에서 설명)
    - BACKWARD::render() 호출
    - BACKWARD::preprocess() 호출

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/22.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/23.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

- rasterizer_impl.cu :  
  - void CudaRasterizer::Rasterizer::markVisible()  
  (아래의 ### markVisible section에서 설명)
    - $$\text{checkFrustum<<<,>>>()}$$ 호출  

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/24.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

### FORWARD

- $$\text{preprocessCUDA<NUM_CHANNELS> <<<(P + 255) / 256, 256 >>>()}$$  
where P : # of Gaussians
  - TBD

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/26.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>
<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid loading="eager" path="assets/img/2024-12-29-3DGScode/27.PNG" class="img-fluid rounded z-depth-1" zoomable=true %}
    </div>
</div>

그림 출처 : https://arxiv.org/abs/2401.03890

- cub::DeviceScan::InclusiveSum()  
  - TBD

- $$\text{duplicatedWithKeys<<<,>>>()}$$  
  - TBD
- cub::DeviceRadixSort::SortPairs()  
  - TBD

- $$\text{identifyTileRanges<<<,>>>()}$$  
  - TBD

- $$\text{renderCUDA<> <<<>>>()}$$  
  - TBD

### BACKWARD

- BACKWARD::render()  
  - TBD

- BACKWARD::preprocess()  
  - TBD

### markVisible

- $$\text{checkFrustum<<<,>>>()}$$  
  - TBD