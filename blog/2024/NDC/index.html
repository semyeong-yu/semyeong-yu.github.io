<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Normalized Device Coordinates | Semyeong Yu </title> <meta name="author" content="Semyeong Yu"> <meta name="description" content="How NDC Works for Ray"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://semyeong-yu.github.io/blog/2024/NDC/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Normalized Device Coordinates",
            "description": "How NDC Works for Ray",
            "published": "July 30, 2024",
            "authors": [
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Semyeong</span> Yu </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Normalized Device Coordinates</h1> <p>How NDC Works for Ray</p> </d-title> <d-article> <h2 id="ndc-normalized-device-coordinates">NDC: Normalized Device Coordinates</h2> <blockquote> <p>referenced blog :<br> <a href="https://yconquesty.github.io/blog/ml/nerf/nerf_ndc.html#background" rel="external nofollow noopener" target="_blank">https://yconquesty.github.io/blog/ml/nerf/nerf_ndc.html#background</a></p> </blockquote> <h3 id="motivation">Motivation</h3> <p>NeRF에서<br> MLP의 input은 3D world-coordinate이고,<br> MLP의 output인 \(c, \sigma\) 를 accumulate해서 2D pixel-coordinate을 채운다<br> 이 때, LLFF (Local Light Field Fusion) dataset 에 있는<br> <code class="language-plaintext highlighter-rouge">unbounded (in single direction) 3D world-coordinate</code>의 scene 정보를<br> <code class="language-plaintext highlighter-rouge">bounded 3D NDC space</code>로 project하면<br> <code class="language-plaintext highlighter-rouge">MLP를 효율적으로 쓸 수 있다</code><br> NDC space로의 projection 과정을 수식적으로 알아보고자 한다.</p> <h3 id="from-world-coordinate-to-ndc-to-pixel-coordinate">From world-coordinate To NDC To pixel-coordinate</h3> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-07-30-NDC/1-480.webp 480w,/assets/img/2024-07-30-NDC/1-800.webp 800w,/assets/img/2024-07-30-NDC/1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2024-07-30-NDC/1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <ul> <li>camera transformation : <ul> <li> <code class="language-plaintext highlighter-rouge">3D world-coordinate</code> (canonical-coordinate)<br> \(\rightarrow\)<br> <code class="language-plaintext highlighter-rouge">3D camera-coordinate</code> </li> <li>extrinsic matrix \(\begin{bmatrix} R &amp; t \\ 0 &amp; 1 \end{bmatrix}\)</li> </ul> </li> <li>projection transformation : <ul> <li> <code class="language-plaintext highlighter-rouge">3D camera-coordinate</code><br> \(\rightarrow\)<br> <code class="language-plaintext highlighter-rouge">3D NDC (normalized-device-coordinate)</code> (canonical view volume)</li> <li>normalized-device-coordinate (NDC) :<br> <code class="language-plaintext highlighter-rouge">camera 원점이 중앙에 있는</code> \([-1, 1]^3\) cube (<code class="language-plaintext highlighter-rouge">정육면체</code>)</li> <li>frustum \(\rightarrow\) 직육면체 \(\rightarrow\) 정육면체<br> consists of perspective projection and then orthographic projection<br> z-axis 방향 바꾸기 포함</li> </ul> </li> <li>viewport transformation : <ul> <li> <code class="language-plaintext highlighter-rouge">3D NDC</code><br> \(\rightarrow\)<br> <code class="language-plaintext highlighter-rouge">2D pixel-coordinate</code> </li> <li>\([-1, 1]^3\) 의 NDC를 flatten하여 2 \(\times\) 2 square를 raster image로 mapping</li> <li>intrinsic matrix \(\begin{bmatrix} f_x &amp; s &amp; W/2 \\ 0 &amp; f_y &amp; H/2 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}\) (초점거리 곱하고 원점 좌상단 이동)<br> y-axis 방향 바꾸기 포함</li> </ul> </li> </ul> <h3 id="projection-transformation">Projection Transformation</h3> <blockquote> <p>Step 1. <code class="language-plaintext highlighter-rouge">Perspective Projection</code></p> </blockquote> <ul> <li>frustum을 bounded cuboid로 변환<br> bound :<br> \(x \in [l, r]\) where \(l \lt 0\), \(r \gt 0\)<br> \(y \in [b, t]\) where \(b \lt 0\), \(t \gt 0\)<br> \(z \in [f, n]\) where \(f \lt 0\), \(n \lt 0\)</li> </ul> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-07-30-NDC/2-480.webp 480w,/assets/img/2024-07-30-NDC/2-800.webp 800w,/assets/img/2024-07-30-NDC/2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2024-07-30-NDC/2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-07-30-NDC/3-480.webp 480w,/assets/img/2024-07-30-NDC/3-800.webp 800w,/assets/img/2024-07-30-NDC/3-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2024-07-30-NDC/3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> 3D camera-coordinate </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/2024-07-30-NDC/4-480.webp 480w,/assets/img/2024-07-30-NDC/4-800.webp 800w,/assets/img/2024-07-30-NDC/4-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/2024-07-30-NDC/4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <ul> <li> <p>\(z = n\) plane은 그대로 냅두고, 직육면체 꼴이 되도록 그 뒤 plane 변환<br> camera를 통과하는 any line은 z-axis에 평행한 line이 됨</p> </li> <li> <p>perspective projection matrix :<br> \(P_{per} = \begin{bmatrix} n &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; n &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; n+f &amp; -nf \\ 0 &amp; 0 &amp; 1 &amp; 0 \end{bmatrix}\)<br> \(P_{per} \begin{bmatrix} X \\ Y \\ Z \\ 1 \end{bmatrix} = \begin{bmatrix} nX \\ nY \\ (n+f)Z - nf \\ Z \end{bmatrix}\)<br> <code class="language-plaintext highlighter-rouge">?????</code></p> </li> </ul> <blockquote> <p>Step 2. <code class="language-plaintext highlighter-rouge">Orthographic Projection</code></p> </blockquote> <ul> <li> <p>corner (l, b, n)이 원점이 되도록 shift한 뒤,<br> \([0, r-l] \times [0, t-b] \times [f-n, 0]\) 의 직육면체를 \([0, 2] \times [0, 2] \times [-2, 0]\) 의 정육면체로 scale한 뒤,<br> center (1, 1, -1)이 원점이 되도록 \([-1, 1]^3\) 으로 shift</p> </li> <li> <p>orthographic projection matrix :<br> \(M_{orth} = \begin{pmatrix} I_{3 \times 3} &amp; \begin{matrix} -1 \\ -1 \\ 1 \end{matrix} \\ 0_{1 \times 3} &amp; 1 \end{pmatrix} \begin{pmatrix} \begin{matrix} \frac{2}{r-l} &amp; 0 &amp; 0 \\ 0 &amp; \frac{2}{t-b} &amp; 0 \\ 0 &amp; 0 &amp; \frac{2}{n-f} \end{matrix} &amp; 0_{3 \times 1} \\ 0_{1 \times 3} &amp; 1 \end{pmatrix} \begin{pmatrix} I_{3 \times 3} &amp; \begin{matrix} -l \\ -b \\ -n \end{matrix} \\ 0_{1 \times 3} &amp; 1 \end{pmatrix}\)<br> \(= \begin{bmatrix} \frac{2}{r-l} &amp; 0 &amp; 0 &amp; -\frac{r+l}{r-l} \\ 0 &amp; \frac{2}{t-b} &amp; 0 &amp; -\frac{t+b}{t-b} \\ 0 &amp; 0 &amp; \frac{2}{n-f} &amp; -\frac{n+f}{n-f} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}\)</p> </li> </ul> <blockquote> <p>Step 3. <code class="language-plaintext highlighter-rouge">Projection Matrix</code></p> </blockquote> <p>Since perspective projection matrix is scalable,<br> \(M_{proj} = M_{orth} (- P_{per})\)<br> \(= \begin{bmatrix} \frac{2}{r-l} &amp; 0 &amp; 0 &amp; -\frac{r+l}{r-l} \\ 0 &amp; \frac{2}{t-b} &amp; 0 &amp; -\frac{t+b}{t-b} \\ 0 &amp; 0 &amp; \frac{2}{n-f} &amp; -\frac{n+f}{n-f} \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix} \begin{bmatrix} -n &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; -n &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; -n-f &amp; nf \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix}\)<br> \(= \begin{bmatrix} -\frac{2n}{r-l} &amp; 0 &amp; \frac{r+l}{r-l} &amp; 0 \\ 0 &amp; -\frac{2n}{t-b} &amp; \frac{t+b}{t-b} &amp; 0 \\ 0 &amp; 0 &amp; -\frac{n+f}{n-f} &amp; \frac{2nf}{n-f} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix}\)</p> <p>camera-coordinate에서 \(z \in [f, n]\) where \(f \lt 0\), \(n \lt 0\) 이었는데,<br> NDC에서는 z-axis의 방향이 반대이므로<br> \(f \lt 0\), \(n \lt 0\) 대신 \(f = -f \gt 0\), \(n = -n \gt 0\) 를 대입하면,<br> \(M_{proj} = \begin{bmatrix} \frac{2n}{r-l} &amp; 0 &amp; \frac{r+l}{r-l} &amp; 0 \\ 0 &amp; \frac{2n}{t-b} &amp; \frac{t+b}{t-b} &amp; 0 \\ 0 &amp; 0 &amp; -\frac{n+f}{n-f} &amp; -\frac{2nf}{n-f} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix}\)</p> <p>OpenGL과 같은 graphics frameworks에서는 보통<br> \(M_{proj}X\) 를 \(M_{proj}X\) 의 fourth entry로 나눴을 때 \(M_{proj}X\) 의 Z 값이 양수가 되도록 하기 때문에 (아래 Step 4의 NDC 참고)<br> 조금 수정하면<br> 최종적인 projection matrix는<br> \(M_{proj} = \begin{bmatrix} \frac{2n}{r-l} &amp; 0 &amp; \frac{r+l}{r-l} &amp; 0 \\ 0 &amp; \frac{2n}{t-b} &amp; \frac{t+b}{t-b} &amp; 0 \\ 0 &amp; 0 &amp; -\frac{n+f}{f-n} &amp; -\frac{2nf}{f-n} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix}\)</p> <p>camera frustum은 보통 symmetric하므로 \(l = -r\), \(b = -t\) 라 했을 때<br> projection matrix는<br> \(M_{proj} = \begin{bmatrix} \frac{n}{r} &amp; 0 &amp; 0 &amp; 0 \\ 0 &amp; \frac{n}{t} &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; -\frac{f+n}{f-n} &amp; -\frac{2nf}{f-n} \\ 0 &amp; 0 &amp; -1 &amp; 0 \end{bmatrix}\)</p> <blockquote> <p>Step 4. from <code class="language-plaintext highlighter-rouge">camera-coordinate</code> to <code class="language-plaintext highlighter-rouge">NDC</code></p> </blockquote> <ul> <li> <p>camera-coordinate :<br> \(\boldsymbol X = \begin{bmatrix} X \\ Y \\ Z \\ 1 \end{bmatrix}\)</p> </li> <li> <p>NDC :<br> \(\begin{bmatrix} -\frac{n}{r}\frac{X}{Z} \\ -\frac{n}{t}\frac{Y}{Z} \\ \frac{f+n}{f-n} + \frac{2nf}{f-n}\frac{1}{Z} \\ 1 \end{bmatrix} = \boldsymbol x \sim M_{proj} \boldsymbol X = \begin{bmatrix} \frac{n}{r}X \\ \frac{n}{t}Y \\ -\frac{f+n}{f-n}Z -\frac{2nf}{f-n} \\ -Z \end{bmatrix}\)<br> Let \(a_x = -\frac{n}{r}\)<br> \(a_y = -\frac{n}{t}\)<br> \(a_z = \frac{f+n}{f-n}\)<br> \(b_z = \frac{2nf}{f-n}\)<br> Then \(\boldsymbol x = \begin{bmatrix} a_x\frac{X}{Z} \\ a_y\frac{Y}{Z} \\ a_z + \frac{b_z}{Z} \\ 1 \end{bmatrix} = \begin{bmatrix} a_x\frac{X}{Z} \\ a_y\frac{Y}{Z} \\ a_z + \frac{b_z}{Z} \end{bmatrix}\)</p> </li> </ul> <h3 id="projection-in-nerf-ray">Projection in NeRF ray</h3> <p>any 3D points on ray \(r = o + td\)를<br> NDC space (camera 원점이 중앙에 있는 \([-1, 1]^3\) cube) 로 projection하면<br> 3D points on projected ray \(r^{\ast} = o^{\ast} + t^{\ast} d^{\ast}\) 가 된다<br> 위에서 유도한 Projection Matrix 를 사용하면<br> \(\boldsymbol x = \begin{bmatrix} a_x\frac{o_x + td_x}{o_z + td_z} \\ a_y\frac{o_y + td_y}{o_z + td_z} \\ a_z + \frac{b_z}{o_z + td_z} \end{bmatrix} = \begin{bmatrix} o_x^{\ast} + t^{\ast} d_x^{\ast} \\ o_y^{\ast} + t^{\ast} d_y^{\ast} \\ o_z^{\ast} + t^{\ast} d_z^{\ast} \end{bmatrix}\)</p> <p>먼저 projected 원점 좌표를 구해보자<br> \(t = t^{\ast} = 0\) 를 대입하면<br> \(o^{\ast} = \begin{bmatrix} o_x^{\ast} \\ o_y^{\ast} \\ o_z^{\ast} \end{bmatrix} = \begin{bmatrix} a_x\frac{o_x}{o_z} \\ a_y\frac{o_y}{o_z} \\ a_z + \frac{b_z}{o_z} \end{bmatrix}\)</p> <p>다음으로 projected t와 d를 구해보자<br> \(\begin{bmatrix} t^{\ast} d_x^{\ast} \\ t^{\ast} d_y^{\ast} \\ t^{\ast} d_z^{\ast} \end{bmatrix} = \begin{bmatrix} a_x\frac{o_x + td_x}{o_z + td_z} \\ a_y\frac{o_y + td_y}{o_z + td_z} \\ a_z + \frac{b_z}{o_z + td_z} \end{bmatrix} - \begin{bmatrix} o_x^{\ast} \\ o_y^{\ast} \\ o_z^{\ast} \end{bmatrix}\)<br> \(= \begin{bmatrix} a_x\frac{o_x + td_x}{o_z + td_z} - a_x\frac{o_x}{o_z} \\ a_y\frac{o_y + td_y}{o_z + td_z} - a_y\frac{o_y}{o_z} \\ a_z + \frac{b_z}{o_z + td_z} - (a_z + \frac{b_z}{o_z}) \end{bmatrix}\)<br> \(= \begin{bmatrix} a_x\frac{td_z}{o_z + td_z}(\frac{d_x}{d_z} - \frac{o_x}{o_z}) \\ a_y\frac{td_z}{o_z + td_z}(\frac{d_y}{d_z} - \frac{o_y}{o_z}) \\ -b_z\frac{td_z}{o_z + td_z}\frac{1}{o_z} \end{bmatrix}\)<br> \(= \frac{td_z}{o_z + td_z} \begin{bmatrix} a_x(\frac{d_x}{d_z} - \frac{o_x}{o_z}) \\ a_y(\frac{d_y}{d_z} - \frac{o_y}{o_z}) \\ -b_z\frac{1}{o_z} \end{bmatrix}\)</p> <blockquote> <p>Result</p> </blockquote> <p>ray \(r = o + td\)를<br> NDC space (camera 원점이 중앙에 있는 \([-1, 1]^3\) cube) 로 projection 했을 때<br> projected ray \(r^{\ast} = o^{\ast} + t^{\ast} d^{\ast}\) 는 아래와 같이 구할 수 있다</p> <p>\(o^{\ast} = \begin{bmatrix} o_x^{\ast} \\ o_y^{\ast} \\ o_z^{\ast} \end{bmatrix} = \begin{bmatrix} a_x\frac{o_x}{o_z} \\ a_y\frac{o_y}{o_z} \\ a_z + \frac{b_z}{o_z} \end{bmatrix}\)<br> and<br> \(t^{\ast} = \frac{td_z}{o_z + td_z} = 1 - \frac{o_z}{o_z + td_z}\)<br> and<br> \(d^{\ast} = \begin{bmatrix} d_x^{\ast} \\ d_y^{\ast} \\ d_z^{\ast} \end{bmatrix} = \begin{bmatrix} a_x(\frac{d_x}{d_z} - \frac{o_x}{o_z}) \\ a_y(\frac{d_y}{d_z} - \frac{o_y}{o_z}) \\ -b_z\frac{1}{o_z} \end{bmatrix}\)</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">Ray Projection to NDC 장점</code></p> </blockquote> <p>ray에서 \(t \in [0, \infty)\) 였다면 projected ray에서 \(t^{\ast} \in [0, 1)\)</p> <p>LLFF dataset에서<br> camera에서 출발한 ray가 아무 object도 “hit”하지 않는다면 \(t = \infty\)일텐데,<br> NDC (bounded cube)로 warp한다면 \(t^{\ast} \in [0, 1)\) 이므로<br> MLP 효율적으로 쓸 수 있음</p> <blockquote> <p>Projection transformation 한계</p> </blockquote> <p>LLFF dataset과 같이 <code class="language-plaintext highlighter-rouge">single</code> direction으로만 unbounded된 camera frustum, 즉 front-facing scene에 대해서만 적용 가능하고<br> unbounded 360 scene에 대해서는 기본 NeRF가 잘 수행 못함<br> \(\rightarrow\) MipNeRF360 등 NeRF 후속 연구에서 해결됨</p> <blockquote> <p>특정 case</p> </blockquote> <p>\(f_{cam}\)이 camera의 focal length이고,<br> \(W, H\)가 image plane의 width, height in pix 일 때<br> image plane이 정확히 camera frustum의 near plane에 있고<br> camera frustum의 far plane을 infinity로 확장하도록<br> camera를 설정하면,<br> \(z = -n = f_{cam} \lt 0\), \(r = \frac{W}{2}\), \(t = \frac{H}{2}\), \(z = -f \rightarrow -\infty\) 이므로</p> <p>\(a_x = -\frac{n}{r} = \frac{f_{cam}}{\frac{W}{2}}\)<br> \(a_y = -\frac{n}{t} = \frac{f_{cam}}{\frac{H}{2}}\)<br> \(\lim_{f \rightarrow \infty} a_z = \lim_{f \rightarrow \infty} \frac{f+n}{f-n} = 1\)<br> \(\lim_{f \rightarrow \infty} b_z = \lim_{f \rightarrow \infty} \frac{2nf}{f-n} = 2n\)<br> 이므로</p> <p>ray \(r = o + td\) 를 NDC로 projection했을 때<br> projected ray \(r^{\ast} = o^{\ast} + t^{\ast} d^{\ast}\) 에서<br> \(o^{\ast} = \begin{bmatrix} \frac{f_{cam}}{\frac{W}{2}}\frac{o_x}{o_z} \\ \frac{f_{cam}}{\frac{H}{2}}\frac{o_y}{o_z} \\ 1 + \frac{2n}{o_z} \end{bmatrix}\)<br> and<br> \(t^{\ast} = \frac{td_z}{o_z + td_z} = 1 - \frac{o_z}{o_z + td_z}\)<br> and<br> \(d^{\ast} = \begin{bmatrix} \frac{f_{cam}}{\frac{W}{2}}(\frac{d_x}{d_z} - \frac{o_x}{o_z}) \\ \frac{f_{cam}}{\frac{H}{2}}(\frac{d_y}{d_z} - \frac{o_y}{o_z}) \\ -2n\frac{1}{o_z} \end{bmatrix}\)</p> <h3 id="ndc-projection-in-nerf-code">NDC projection in NeRF code</h3> <p><a href="https://github.com/yenchenlin/nerf-pytorch" rel="external nofollow noopener" target="_blank">NeRF-Pytorch</a> 기준으로<br> run_nerf_helpers.py의 ndc_rays()에서 구현</p> <pre><code class="language-Python">def ndc_rays(H, W, focal, near, rays_o, rays_d):
    # shift ray origins to near plane
    t = -(near + rays_o[...,2]) / rays_d[...,2]
    rays_o = rays_o + t[...,None] * rays_d
    
    # projection
    o0 = -1. / (W / (2. * focal)) * rays_o[...,0] / rays_o[...,2]
    o1 = -1. / (H / (2. * focal)) * rays_o[...,1] / rays_o[...,2]
    o2 =  1. +  2. * near / rays_o[...,2]

    d0 = -1. / (W / (2. * focal)) * (rays_d[...,0]/rays_d[...,2] - rays_o[...,0]/rays_o[...,2])
    d1 = -1. / (H / (2. * focal)) * (rays_d[...,1]/rays_d[...,2] - rays_o[...,1]/rays_o[...,2])
    d2 = -2. * near / rays_o[...,2]
    
    rays_o = torch.stack([o0,o1,o2], -1)
    rays_d = torch.stack([d0,d1,d2], -1)
    
    return rays_o, rays_d
</code></pre> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> <div id="giscus_thread" style="max-width: 800px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"semyeong-yu/semyeong-yu.github.io","data-repo-id":"R_kgDOLmVJXQ","data-category":"Comments","data-category-id":"DIC_kwDOLmVJXc4CeSwc","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Semyeong Yu. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-5YMLX9VHFX"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5YMLX9VHFX");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>